  deploy_dev:
    runs-on: [self-hosted, pc, dev]
    defaults: { run: { shell: cmd } }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "20", cache: "npm" }

      - run: npm ci --omit=dev

      - name: PM2 deploy (dev)
        run: |
          set "PM2_HOME=%GITHUB_WORKSPACE%\.pm2"
          if not exist "%PM2_HOME%" mkdir "%PM2_HOME%"
          cd
          dir
          where node
          node -v
          npx --yes pm2 --version
          rem حاول ريستارت، أو شغّل لو مش موجود
          npx --yes pm2 restart demo-ci || npx --yes pm2 start index.js --name demo-ci
          npx --yes pm2 save

      - name: PM2 debug (dev)
        if: always()
        run: |
          set "PM2_HOME=%GITHUB_WORKSPACE%\.pm2"
          npx --yes pm2 list
          npx --yes pm2 describe demo-ci
          echo ===== PM2 logs dir =====
          dir "%PM2_HOME%\logs"
          echo ===== error log =====
          type "%PM2_HOME%\logs\demo-ci-error.log" 2> NUL || echo (no error log)
          echo ===== out log =====
          type "%PM2_HOME%\logs\demo-ci-out.log" 2> NUL || echo (no out log)
          echo ===== who uses :3000 =====
          netstat -ano | find ":3000" || echo (no one)

      - name: Health check (dev)
        run: |
          curl -sSf http://localhost:3000/hello >NUL
          curl -sSf http://localhost:3000/bye >NUL
